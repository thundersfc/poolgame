<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poolix Fly Mamae</title>
    <style>
        :root {
            --primary: #3498db;
            --bg: #0f172a;
            --accent: #f43f5e;
            --gold: #fbbf24;
        }
        body { 
            margin: 0; 
            padding: 0;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: var(--bg); 
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: white;
            overflow: hidden;
            touch-action: none;
        }
        #game-wrapper {
            position: relative;
            background: #000;
            border: 4px solid #334155;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            width: 95vw;
            max-width: 400px;
            aspect-ratio: 2/3;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .hud {
            position: absolute;
            top: 20px;
            width: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
        }
        .score-container {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            padding: 8px 24px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .score { font-size: 52px; font-weight: 900; color: #fff; line-height: 1; }
        .high-score { font-size: 12px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px;}
        
        #overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
            padding: 30px;
        }

        #game-over-card {
            background: #1e293b;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 30px;
            width: 80%;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: popIn 0.4s ease-out;
        }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .start-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 900;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
            text-transform: uppercase;
        }
        .start-btn:hover { transform: scale(1.05); }

        #super-badge {
            position: absolute;
            bottom: 20px;
            background: var(--gold);
            color: black;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 900;
            display: none;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="overlay">
            <div id="menu-content">
                <h1 style="font-size: 38px; margin: 0; letter-spacing: -1px;">POOLIX FLY MAMAE</h1>
                <p style="color: #94a3b8; margin: 10px 0 30px;">Survival of the Girest</p>
                <button class="start-btn" onclick="startGame()">START OOMBING</button>
            </div>

            <div id="game-over-card">
                <h2 id="death-msg" style="margin: 0 0 10px; color: #f43f5e;">FLUSHED in KAKKOS! ðŸš½</h2>
                <div style="font-size: 14px; color: #94a3b8; text-transform: uppercase;">Final Umbal</div>
                <div style="font-size: 64px; font-weight: 900;" id="final-score-val">0</div>
                <div id="best-score-label" style="font-size: 14px; color: var(--gold); margin-bottom: 20px;">BEST: 0</div>
                <button class="start-btn" onclick="startGame()">Meendum mbal</button>
            </div>
        </div>

        <div class="hud">
            <div class="score-container">
                <div class="score" id="score-val">0</div>
                <div class="high-score" id="high-score-val">BEST: 0</div>
                <div id="weather-label" style="font-size: 10px; margin-top: 5px; opacity: 0.7; letter-spacing: 1px;">DAY / CLEAR</div>
            </div>
        </div>

        <div id="super-badge">GAYNTHI MODE ACTIVE! ðŸ”¥</div>
        <canvas id="mainCanvas" width="400" height="600"></canvas>
    </div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const scoreVal = document.getElementById('score-val');
    const highScoreVal = document.getElementById('high-score-val');
    const overlay = document.getElementById('overlay');
    const menuContent = document.getElementById('menu-content');
    const gameOverCard = document.getElementById('game-over-card');
    const finalScoreDisplay = document.getElementById('final-score-val');
    const bestScoreDisplay = document.getElementById('best-score-label');
    const weatherLabel = document.getElementById('weather-label');
    const superBadge = document.getElementById('super-badge');

    // Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(freq, type, duration, vol = 0.05, slide = true) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        if(slide) osc.frequency.exponentialRampToValueAtTime(freq/4, audioCtx.currentTime + duration);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // Assets
    const birdImg = new Image(); birdImg.src = 'bird.png'; 
    const ajithImg = new Image(); ajithImg.src = 'ajith.png';

    // Game State
    let isPlaying = false;
    let isDying = false;
    let score = 0;
    let highScore = 0;
    let frame = 0;
    let entities = [];
    let powerUps = [];
    let weatherParticles = [];
    let player = { x: 80, y: 300, w: 85, h: 85, vy: 0, rot: 0, scale: 1, alpha: 1 };
    
    // Power up
    let superMode = false;
    let superTimer = 0;
    
    // Death Animation State
    let deathFrame = 0;
    let toiletX = 200;
    let toiletY = 700;

    // Atmosphere
    let timeOfDay = 'day';
    let weatherType = 'clear';

    window.addEventListener('keydown', e => { if (e.code === 'Space') playerJump(); });
    canvas.addEventListener('mousedown', playerJump);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); playerJump(); }, {passive: false});

    function playerJump() {
        if (!isPlaying || isDying) return;
        player.vy = -7.5;
        playSfx(450, 'triangle', 0.1);
    }

    function resetGame() {
        score = 0; frame = 0; entities = []; powerUps = []; weatherParticles = [];
        superMode = false; superTimer = 0; isDying = false; deathFrame = 0;
        player.y = 200; player.vy = 0; player.rot = 0; player.scale = 1; player.alpha = 1;
        scoreVal.innerText = "0";
        superBadge.style.display = 'none';
        updateAtmosphere();
    }

    function startGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        resetGame(); isPlaying = true;
        overlay.style.display = 'none';
        menuContent.style.display = 'flex';
        gameOverCard.style.display = 'none';
        requestAnimationFrame(update);
    }

    function triggerDeath() {
        if (isDying || superMode) return;
        isDying = true;
        deathFrame = 0;
        toiletY = canvas.height + 100;
        playSfx(100, 'sawtooth', 0.5, 0.2);
    }

    function showGameOver() {
        isPlaying = false;
        if (score > highScore) highScore = score;
        overlay.style.display = 'flex';
        menuContent.style.display = 'none';
        gameOverCard.style.display = 'flex';
        finalScoreDisplay.innerText = score;
        bestScoreDisplay.innerText = `BEST: ${highScore}`;
        highScoreVal.innerText = `BEST: ${highScore}`;
    }

    function updateAtmosphere() {
        if (score < 5) timeOfDay = 'day';
        else if (score < 15) timeOfDay = 'sunset';
        else timeOfDay = 'night';

        if (score % 15 === 0 && score > 0) {
            const rand = Math.random();
            if (rand < 0.4) weatherType = 'clear';
            else if (rand < 0.7) weatherType = 'rain';
            else weatherType = 'snow';
        }
        weatherLabel.innerText = `${timeOfDay.toUpperCase()} / ${weatherType.toUpperCase()}`;
    }

    function spawnWeather() {
        if (weatherType === 'clear' || isDying) return;
        if (frame % 2 === 0) {
            weatherParticles.push({
                x: Math.random() * canvas.width,
                y: -10,
                vy: weatherType === 'rain' ? 12 : 3,
                vx: weatherType === 'rain' ? 1 : (Math.random() - 0.5) * 2,
                size: weatherType === 'rain' ? 1 : 3
            });
        }
    }

    function drawToilet(y) {
        ctx.save();
        ctx.translate(player.x + 40, y);
        // Toilet Tank
        ctx.fillStyle = '#e2e8f0';
        ctx.fillRect(-40, -100, 80, 60);
        // Toilet Bowl
        ctx.beginPath();
        ctx.ellipse(0, -20, 60, 40, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#94a3b8';
        ctx.lineWidth = 5;
        ctx.stroke();
        // Hole
        ctx.fillStyle = '#1e293b';
        ctx.beginPath();
        ctx.ellipse(0, -20, 35, 20, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }

    function update() {
        if (!isPlaying) return;
        frame++;

        // 1. Death Animation Overrides
        if (isDying) {
            deathFrame++;
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // Toilet rises
            if (deathFrame < 50) toiletY -= (toiletY - (player.y + 100)) * 0.1;
            drawToilet(toiletY);

            // Bird falls into toilet
            if (deathFrame > 50 && deathFrame < 100) {
                player.y += (toiletY - 40 - player.y) * 0.1;
                player.scale *= 0.95;
                player.rot += 0.5;
            }

            // Flush effect
            if (deathFrame === 100) {
                playSfx(150, 'white', 1.5, 0.3, false); // Flush sound
            }
            if (deathFrame > 100) {
                player.alpha *= 0.8;
                // Vortex
                ctx.strokeStyle = '#38bdf8';
                ctx.lineWidth = 2;
                for(let i=0; i<5; i++) {
                    ctx.beginPath();
                    let r = (deathFrame - 100) * 5 + (i * 20);
                    ctx.arc(player.x + 40, toiletY - 40, r % 100, deathFrame*0.1, deathFrame*0.1 + Math.PI);
                    ctx.stroke();
                }
            }

            if (deathFrame > 160) showGameOver();
        } else {
            // 2. Normal Gameplay Background
            let bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            if (superMode) {
                bgGrad.addColorStop(0, '#f59e0b'); bgGrad.addColorStop(1, '#78350f');
            } else if (timeOfDay === 'day') {
                bgGrad.addColorStop(0, '#7dd3fc'); bgGrad.addColorStop(1, '#bae6fd');
            } else if (timeOfDay === 'sunset') {
                bgGrad.addColorStop(0, '#f97316'); bgGrad.addColorStop(1, '#4c1d95');
            } else {
                bgGrad.addColorStop(0, '#020617'); bgGrad.addColorStop(1, '#1e1b4b');
            }
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            spawnWeather();
            ctx.fillStyle = weatherType === 'rain' ? 'rgba(186, 230, 253, 0.6)' : 'white';
            for(let i = weatherParticles.length - 1; i >= 0; i--) {
                let p = weatherParticles[i];
                p.x += p.vx; p.y += p.vy;
                if (weatherType === 'rain') ctx.fillRect(p.x, p.y, 1, 12);
                else { ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); }
                if (p.y > canvas.height) weatherParticles.splice(i, 1);
            }

            // 3. Physics & Super Mode
            player.vy += 0.38;
            player.y += player.vy;

            if (superMode) {
                superTimer--;
                if (superTimer <= 0) {
                    superMode = false;
                    superBadge.style.display = 'none';
                }
            }

            // 4. Entities
            if (frame % 100 === 0) {
                let gap = superMode ? 350 : 220; 
                let h = Math.random() * (canvas.height - gap - 200) + 100;
                entities.push({ x: canvas.width, y: 0, w: 80, h: h, passed: false });
                entities.push({ x: canvas.width, y: h + gap, w: 80, h: canvas.height - (h+gap) });
            }

            if (frame % 450 === 0 && !superMode) {
                powerUps.push({ x: canvas.width, y: 200 + Math.random() * 200, r: 40, angle: 0 });
            }

            // Bubble
            for(let i = powerUps.length - 1; i >= 0; i--) {
                let s = powerUps[i];
                s.x -= 3.5;
                s.angle += 0.08;
                let bob = Math.sin(s.angle) * 12;
                ctx.save();
                ctx.translate(s.x, s.y + bob);
                let g = ctx.createRadialGradient(0,0,0,0,0,s.r);
                g.addColorStop(0, 'rgba(255,215,0,0.4)'); g.addColorStop(1, 'rgba(255,255,255,0.1)');
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.arc(0,0,s.r,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                if (ajithImg.complete) {
                    ctx.beginPath(); ctx.arc(0,0,s.r-5,0,Math.PI*2); ctx.clip();
                    ctx.drawImage(ajithImg, -s.r, -s.r, s.r*2, s.r*2);
                }
                ctx.restore();

                if (Math.hypot(player.x + 40 - s.x, player.y + 40 - (s.y + bob)) < 65) {
                    powerUps.splice(i, 1);
                    superMode = true;
                    superTimer = 400;
                    superBadge.style.display = 'block';
                    playSfx(800, 'square', 0.3);
                }
            }

            // Pipes
            for(let i = entities.length - 1; i >= 0; i--) {
                let p = entities[i];
                p.x -= superMode ? 7 : 3.8;
                ctx.fillStyle = timeOfDay === 'night' ? '#1e293b' : '#334155';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.strokeStyle = superMode ? 'gold' : 'rgba(255,255,255,0.2)';
                ctx.lineWidth = superMode ? 4 : 1;
                ctx.strokeRect(p.x, p.y, p.w, p.h);

                if (!superMode) {
                    const m = 30;
                    if (player.x + m < p.x + p.w && player.x + player.w - m > p.x &&
                        player.y + m < p.y + p.h && player.y + player.h - m > p.y) triggerDeath();
                }

                if (!p.passed && p.x + p.w < player.x) {
                    p.passed = true;
                    if (i % 2 === 0) {
                        score++; scoreVal.innerText = score;
                        updateAtmosphere();
                        playSfx(700, 'sine', 0.1);
                    }
                }
                if (p.x < -100) entities.splice(i, 1);
            }

            if (player.y + player.h > canvas.height || player.y < -250) triggerDeath();
        }

        // 5. Final Render Player
        ctx.save();
        ctx.globalAlpha = player.alpha;
        let pRot = isDying ? player.rot : Math.min(Math.PI/6, Math.max(-Math.PI/6, player.vy * 0.1));
        ctx.translate(player.x + player.w/2, player.y + player.h/2);
        ctx.rotate(pRot);
        ctx.scale(player.scale, player.scale);
        
        if (superMode) {
            ctx.shadowBlur = 30; ctx.shadowColor = 'gold';
            let s = 1 + Math.sin(frame*0.2)*0.1;
            ctx.scale(s, s);
        }

        let curImg = superMode ? ajithImg : birdImg;
        if (curImg.complete) {
            ctx.drawImage(curImg, -player.w/2, -player.h/2, player.w, player.h);
        } else {
            ctx.fillStyle = superMode ? 'gold' : 'yellow';
            ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
        }
        ctx.restore();

        requestAnimationFrame(update);
    }
</script>
</body>
</html>
